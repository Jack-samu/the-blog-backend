name: Python Backend test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: course
          MYSQL_USER: guest
          MYSQL_PASSWORD: Guest123@
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # mysqlæ•°æ®åˆå§‹åŒ–æ£€æŸ¥
    - name: Verify Mysql initialization
      run: |
        for i in {1..10};do
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" >/dev/null 2>&1; then
            echo "Mysql is ready"
            exit 0
          fi
          sleep 2
        done
        echo "Mysql failed to start"
        exit 1

    # pytestæ­£å¼æµ‹è¯•
    - name: Run tests with pytest
      env:
        MAIL_SERVER:  'smtp.163.com'
        MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        MAIL_PORT: ${{secrets.MAIL_PORT}}
        DATABASE_URI: mysql+pymysql://guest:Guest123%40@localhost:3306/course?charset=utf8mb4&connect_timeout=20
      run: |
        pytest tests/ --cov=app --cov-report=html --timeout=40 \
        || echo "::set-output name=test_result::failure"

    # è¦†ç›–ç‡
    - name: Upload coverage
      uses: codecov/codecov-action@v3

    - name: Generate test summary
      id: test-summary
      run: |
        echo "::set-output name=passed::$(grep -o 'tests.*passed' .coverage_output | wc -l)"
        echo "::set-output name=failed::$(grep -o 'tests.*failed' .coverage_output | wc -l)"
    
    # ç»“æœé€šçŸ¥
    - name: Email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.163.com
        server_port: 25
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "Github CICD backend test results (${{ job.status }}): ${{github.respository}}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        body: |
          ğŸ“Š Test Results
          ===============
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Status: ${{ job.status }}
          
          ğŸ“Œ Test Summary:
          - Passed: ${{ steps.test-summary.outputs.passed }}
          - Failed: ${{ steps.test-summary.outputs.failed }}
          - Coverage: $(grep -o 'line-rate="[0-9.]*"' coverage.xml | cut -d'"' -f2)
          
          ğŸ” Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        html_body: |
          <h1>ğŸ“Š Test Results</h1>
          <p><strong>Status:</strong> ${{ job.status }}</p>
          <pre>$(grep -E '(errors|failures)=' test-results.xml | sed 's/.*\(errors\|failures\)="\([0-9]*\)".*/\1: \2/')</pre>
          <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Report</a>